"use client"

import React, { useState, ErrorInfo } from "react"
import { useRouter } from "next/navigation"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { Checkbox } from "@/components/ui/checkbox"
import { Progress } from "@/components/ui/progress"
import { Textarea } from "@/components/ui/textarea"
import { Switch } from "@/components/ui/switch"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Badge } from "@/components/ui/badge"
import { useApp } from "@/lib/store/enhanced-context"
import { AppLogo } from "@/components/app-logo"
import { Heart, User, ChevronRight, ChevronLeft, Plus, Stethoscope, Settings, ArrowLeft, Pill, Users, FileText, Shield, Bell, Database, Wrench, Eye, Upload, X } from "lucide-react"
import Link from "next/link"
import { diseasePresets, mockInformationSources, mockProtocols, toolPresets } from "@/lib/data/mock-sources"
import { HealthCondition, InformationBase, InformationSource, Protocol, Tool, UserData } from "@/lib/types"

// Simple Error Boundary Component
class ErrorBoundary extends React.Component<
  { children: React.ReactNode },
  { hasError: boolean; error?: Error }
> {
  constructor(props: { children: React.ReactNode }) {
    super(props)
    this.state = { hasError: false }
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Error in condition selector:', error, errorInfo)
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-md w-full p-6">
            <h3 className="text-lg font-semibold text-red-600 mb-2">Something went wrong</h3>
            <p className="text-gray-600 mb-4">
              There was an error loading the condition selector. Please try refreshing the page.
            </p>
            <Button 
              onClick={() => window.location.reload()} 
              className="w-full wellness-button-primary"
            >
              Refresh Page
            </Button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}

export default function SetupPage() {
  const router = useRouter()
  const { state, actions, isReady } = useApp()
  const [step, setStep] = useState(1)
  const [loading, setLoading] = useState(false)
  const [showConditionSelector, setShowConditionSelector] = useState(false)
  const [showGoalDetail, setShowGoalDetail] = useState(false)
  const [selectedGoalForDetail, setSelectedGoalForDetail] = useState("")

  // User profile state
  const [profile, setProfile] = useState({
    name: "",
    age: "",
    gender: "",
    height: "",
    weight: "",
  })

  // Enhanced Conditions state with comprehensive data
  const [selectedConditions, setSelectedConditions] = useState<HealthCondition[]>([])
  const [customConditionName, setCustomConditionName] = useState("")
  const [currentConditionStep, setCurrentConditionStep] = useState<"select" | "info-base" | "protocols" | "tools">("select")
  const [currentConditionIndex, setCurrentConditionIndex] = useState(0)

  // Goals state
  const [selectedGoals, setSelectedGoals] = useState<string[]>([])
  const [goalDetails, setGoalDetails] = useState<{ [key: string]: string }>({})

  // Protocols state
  const [selectedProtocols, setSelectedProtocols] = useState<string[]>([])

  // Selected Tools state (replaces medications)
  const [selectedTools, setSelectedTools] = useState<Tool[]>([])

  // Emergency contacts state
  const [emergencyContacts, setEmergencyContacts] = useState<Array<{
    name: string
    relationship: string
    phone: string
    email: string
    isPrimary: boolean
  }>>([])

  // User Data state (Electronic Health Records, Genetic Info, etc.)
  const [userData, setUserData] = useState<Array<{
    id: string
    type: 'ehr' | 'genetic' | 'lab_results' | 'imaging' | 'doctor_notes' | 'family_history' | 'other'
    title: string
    description: string
    fileUrl?: string
    content?: string
    uploadDate: string
    source?: string
  }>>([])

  // Information Base state for each condition
  const [conditionInfoBases, setConditionInfoBases] = useState<Record<string, {
    selectedPresets: string[]
    customSources: InformationSource[]
    excludedSources: string[]
  }>>({})

  // Protocols state for each condition
  const [conditionProtocols, setConditionProtocols] = useState<Record<string, Protocol[]>>({})

  // Preferences state
  const [preferences, setPreferences] = useState({
    notifications: {
      medication: true,
      symptoms: true,
      mood: true,
      appointments: true,
      reminders: true,
    },
    privacy: {
      shareData: false,
      analytics: true,
      dataRetention: 365,
    },
    language: "en",
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
  })

  const totalSteps = 8
  const progress = (step / totalSteps) * 100

  // Show loading if context is not ready
  if (!isReady) {
    return (
      <div className="min-h-screen wellness-gradient flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin w-8 h-8 border-4 border-red-500 border-t-transparent rounded-full mx-auto mb-4"></div>
          <p className="text-gray-600">Loading setup...</p>
        </div>
      </div>
    )
  }





  const handleProfileChange = (field: string, value: string) => {
    setProfile((prev) => ({ ...prev, [field]: value }))
  }

  const handleConditionAdd = (conditionId: string, isCustom = false, customName = "") => {
    try {
      const preset = diseasePresets.find(d => d.id === conditionId)
      if (!preset && !isCustom) {
        console.warn('No preset found for condition:', conditionId)
        return
      }

      // Check for duplicates
      const exists = selectedConditions.some(c => 
        (isCustom && c.name.toLowerCase() === customName.toLowerCase()) ||
        (!isCustom && c.id === conditionId)
      )
      
      if (exists) {
        console.warn('Condition already exists')
        return
      }

      const newCondition: HealthCondition = {
        id: isCustom ? `custom-${Date.now()}` : conditionId,
        name: isCustom ? customName : preset!.name,
        type: isCustom ? "custom" : "preset",
        description: isCustom ? `Custom condition: ${customName}` : preset!.description,
        diagnosedDate: new Date().toISOString(),
        severity: "moderate",
        isActive: true,
        informationBase: {
          id: `info-${Date.now()}`,
          conditionId: isCustom ? `custom-${Date.now()}` : conditionId,
          selectedPresets: [],
          customSources: [],
          excludedSources: [],
          lastUpdated: new Date().toISOString()
        },
        protocols: [],
        tools: [],
        medications: [],
        triggers: [],
        symptoms: []
      }

      setSelectedConditions(prev => [...prev, newCondition])
      setCurrentConditionIndex(selectedConditions.length)
      setCurrentConditionStep("info-base")
      
      console.log('Added condition:', newCondition.name)
    } catch (error) {
      console.error('Error adding condition:', error)
    }
  }

  const handleConditionRemove = (conditionId: string) => {
    setSelectedConditions(prev => prev.filter(c => c.id !== conditionId))
  }

  const updateConditionInformationBase = (conditionId: string, updates: Partial<InformationBase>) => {
    setSelectedConditions(prev => prev.map(condition => 
      condition.id === conditionId 
        ? { ...condition, informationBase: { ...condition.informationBase, ...updates } }
        : condition
    ))
  }

  const updateConditionProtocols = (conditionId: string, protocols: Protocol[]) => {
    setSelectedConditions(prev => prev.map(condition => 
      condition.id === conditionId 
        ? { ...condition, protocols }
        : condition
    ))
  }

  const updateConditionTools = (conditionId: string, tools: Tool[]) => {
    setSelectedConditions(prev => prev.map(condition => 
      condition.id === conditionId 
        ? { ...condition, tools }
        : condition
    ))
  }

  const handleGoalToggle = (goal: string) => {
    setSelectedGoals((prev) => (prev.includes(goal) ? prev.filter((g) => g !== goal) : [...prev, goal]))
  }

  const handleGoalDetailSave = (goal: string, detail: string) => {
    setGoalDetails((prev) => ({ ...prev, [goal]: detail }))
    setShowGoalDetail(false)
    setSelectedGoalForDetail("")
  }

  const addUserData = (type: 'ehr' | 'genetic' | 'lab_results' | 'imaging' | 'doctor_notes' | 'family_history' | 'other') => {
    const newData = {
      id: `data-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      type,
      title: "",
      description: "",
      uploadDate: new Date().toISOString(),
      source: ""
    }
    setUserData(prev => [...prev, newData])
  }

  const updateUserData = (id: string, field: string, value: string) => {
    setUserData(prev => prev.map(data => data.id === id ? { ...data, [field]: value } : data))
  }

  const removeUserData = (id: string) => {
    setUserData(prev => prev.filter(data => data.id !== id))
  }

  const toggleTool = (tool: Tool) => {
    setSelectedTools(prev => {
      const exists = prev.find(t => t.id === tool.id)
      if (exists) {
        return prev.filter(t => t.id !== tool.id)
      } else {
        return [...prev, { ...tool, configuration: {} }]
      }
    })
  }

  const updateToolConfiguration = (toolId: string, config: Record<string, any>) => {
    setSelectedTools(prev => prev.map(tool => 
      tool.id === toolId ? { ...tool, configuration: { ...tool.configuration, ...config } } : tool
    ))
  }

  const addEmergencyContact = () => {
    setEmergencyContacts((prev) => [...prev, { name: "", relationship: "", phone: "", email: "", isPrimary: false }])
  }

  const updateEmergencyContact = (index: number, field: string, value: string | boolean) => {
    setEmergencyContacts((prev) => prev.map((contact, i) => i === index ? { ...contact, [field]: value } : contact))
  }

  const removeEmergencyContact = (index: number) => {
    setEmergencyContacts((prev) => prev.filter((_, i) => i !== index))
  }

  const handleComplete = async () => {
    setLoading(true)

    try {
      // Create user profile
      const userId = `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
      const user = {
        id: userId,
        name: profile.name,
        age: profile.age,
        gender: profile.gender,
        height: profile.height,
        weight: profile.weight,
        email: "",
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        preferences: {
          theme: "light" as const,
          notifications: preferences.notifications,
          privacy: preferences.privacy,
          language: preferences.language,
          timezone: preferences.timezone,
        },
        emergencyContacts: emergencyContacts.map((contact, index) => ({
          id: `contact-${index}`,
          ...contact,
        })),
      }

      actions.setUser(user)

      // Add selected conditions
      selectedConditions.forEach((condition) => {
        console.log("Adding condition:", condition.name)
        // Here you would typically save to your backend or state management
      })

      // Add selected goals
      selectedGoals.forEach((goalTitle) => {
        console.log("Adding goal:", goalTitle, goalDetails[goalTitle] || "")
      })

      // Add user data (EHR, genetic info, etc.)
      userData.forEach((data) => {
        if (data.title && data.type) {
          console.log("Adding user data:", data.type, data.title)
        }
      })

      // Add selected tools
      selectedTools.forEach((tool) => {
        console.log("Adding tool:", tool.name, "with config:", tool.configuration)
      })

      // Add condition-specific information bases and protocols
      Object.entries(conditionInfoBases).forEach(([conditionId, infoBase]) => {
        console.log("Adding info base for condition:", conditionId, infoBase)
      })

      Object.entries(conditionProtocols).forEach(([conditionId, protocols]) => {
        console.log("Adding protocols for condition:", conditionId, protocols.length, "protocols")
      })

      // Simulate API call
      await new Promise((resolve) => setTimeout(resolve, 1500))

      router.push("/dashboard")
    } catch (error) {
      console.error("Setup failed:", error)
      actions.setLoading(false)
    } finally {
      setLoading(false)
    }
  }

  // Group disease presets by category for better organization
  const diseasesByCategory = React.useMemo(() => {
    try {
      return diseasePresets.reduce((acc, disease) => {
        if (!acc[disease.category]) {
          acc[disease.category] = []
        }
        acc[disease.category].push(disease)
        return acc
      }, {} as Record<string, typeof diseasePresets>)
    } catch (error) {
      console.error('Error grouping diseases by category:', error)
      return {}
    }
  }, [])

  // Debug logging
  React.useEffect(() => {
    console.log('Setup page mounted, step:', step)
    console.log('Disease presets loaded:', diseasePresets.length)
    console.log('Diseases by category:', Object.keys(diseasesByCategory))
  }, [step, diseasesByCategory])

  const goals = [
    "Better medication adherence",
    "Improved symptom tracking",
    "Better sleep quality",
    "More physical activity",
    "Stress management",
    "Better communication with doctors",
    "Understanding my condition better",
    "Managing side effects",
  ]

  const protocols = [
    { id: "asthma-management", name: "Asthma Management Protocol", description: "Daily monitoring and emergency response plan" },
    { id: "diabetes-care", name: "Diabetes Care Protocol", description: "Blood sugar monitoring and insulin management" },
    { id: "mental-health", name: "Mental Health Support", description: "Stress management and coping strategies" },
    { id: "nutrition", name: "Nutrition Guidelines", description: "Healthy eating plans for chronic conditions" },
    { id: "exercise", name: "Safe Exercise Protocol", description: "Physical activity guidelines for your condition" },
  ]

  return (
    <div className="min-h-screen wellness-gradient pb-20">
      {/* Header */}
      <header className="wellness-header flex items-center justify-between">
        <Link href="/">
          <Button variant="ghost" size="icon" className="text-gray-600">
            <ArrowLeft className="w-5 h-5" />
          </Button>
        </Link>
        <div className="flex-1 text-center">
          <AppLogo variant="icon" size="sm" />
        </div>
        <div className="text-sm text-gray-500">
          Step {step} of {totalSteps}
        </div>
      </header>

      <main className="px-4 py-8 sm:px-6 lg:px-8">
        <div className="max-w-4xl mx-auto">
          {/* Progress Bar */}
          <div className="mb-8">
            <Progress value={progress} className="h-3 rounded-full" />
          </div>

          {/* Step 1: Basic Info */}
          {step === 1 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-red-50 mx-auto mb-4">
                  <User className="w-8 h-8 text-red-600" />
                </div>
                <CardTitle className="text-2xl">Welcome to WellnessGrid</CardTitle>
                <p className="text-gray-600">Let's start by getting to know you</p>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label htmlFor="name">What's your name?</Label>
                  <Input
                    id="name"
                    placeholder="Your first name"
                    value={profile.name}
                    onChange={(e) => handleProfileChange("name", e.target.value)}
                    className="mt-1 rounded-2xl"
                  />
                </div>

                <div>
                  <Label htmlFor="age">How old are you?</Label>
                  <Input
                    id="age"
                    type="number"
                    placeholder="Your age"
                    value={profile.age}
                    onChange={(e) => handleProfileChange("age", e.target.value)}
                    className="mt-1 rounded-2xl"
                    min="13"
                    max="19"
                  />
                </div>

                <div className="flex justify-end">
                  <Button
                    className="wellness-button-primary"
                    onClick={() => setStep(2)}
                    disabled={!profile.name || !profile.age}
                  >
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 2: Physical Info */}
          {step === 2 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-pink-50 mx-auto mb-4">
                  <Heart className="w-8 h-8 text-pink-600" />
                </div>
                <CardTitle className="text-2xl">Tell us about yourself</CardTitle>
                <p className="text-gray-600">This helps us personalize your health journey</p>
              </CardHeader>
              <CardContent className="space-y-6">
                <div>
                  <Label className="block mb-2">Gender</Label>
                  <RadioGroup
                    value={profile.gender}
                    onValueChange={(value) => handleProfileChange("gender", value)}
                    className="flex flex-wrap gap-4"
                  >
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="male" id="male" />
                      <Label htmlFor="male">Male</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="female" id="female" />
                      <Label htmlFor="female">Female</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="non-binary" id="non-binary" />
                      <Label htmlFor="non-binary">Non-binary</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="prefer-not" id="prefer-not" />
                      <Label htmlFor="prefer-not">Prefer not to say</Label>
                    </div>
                  </RadioGroup>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="height">Height (cm)</Label>
                    <Input
                      id="height"
                      type="number"
                      placeholder="e.g., 165"
                      value={profile.height}
                      onChange={(e) => handleProfileChange("height", e.target.value)}
                      className="mt-1 rounded-2xl"
                    />
                  </div>
                  <div>
                    <Label htmlFor="weight">Weight (kg)</Label>
                    <Input
                      id="weight"
                      type="number"
                      placeholder="e.g., 60"
                      value={profile.weight}
                      onChange={(e) => handleProfileChange("weight", e.target.value)}
                      className="mt-1 rounded-2xl"
                    />
                  </div>
                </div>

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(1)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button className="wellness-button-primary" onClick={() => setStep(3)} disabled={!profile.gender}>
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 3: Health Conditions */}
          {step === 3 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-red-50 mx-auto mb-4">
                  <Stethoscope className="w-8 h-8 text-red-600" />
                </div>
                <CardTitle className="text-2xl">Health Conditions</CardTitle>
                <p className="text-gray-600">Select the conditions you're managing</p>
              </CardHeader>
              <CardContent className="space-y-8">
                {/* Selected Conditions */}
                {selectedConditions.map((condition) => (
                  <Card key={condition.id} className="border border-red-200 bg-red-50">
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                          <span className="text-2xl">
                            {condition.type === "custom" ? "‚ùì" : diseasePresets.find(d => d.id === condition.id)?.icon}
                          </span>
                          <div>
                            <h4 className="font-medium">{condition.name}</h4>
                            <p className="text-sm text-gray-600">{condition.description}</p>
                            <Badge variant="outline" className="mt-1 text-xs">
                              {condition.type === "custom" ? "Custom" : diseasePresets.find(d => d.id === condition.id)?.category}
                            </Badge>
                          </div>
                        </div>
                        <Button variant="ghost" size="sm" onClick={() => handleConditionRemove(condition.id)}>
                          Remove
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                ))}

                {/* Add Condition Button */}
                <Card
                  className="border-2 border-dashed border-gray-300 cursor-pointer hover:border-red-400 transition-colors"
                  onClick={() => setShowConditionSelector(true)}
                >
                  <CardContent className="p-6 text-center">
                    <Plus className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                    <p className="text-gray-600">Add Condition</p>
                  </CardContent>
                </Card>

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(2)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button
                    className="wellness-button-primary"
                    onClick={() => setStep(4)}
                    disabled={selectedConditions.length === 0}
                  >
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 4: Medications */}
          {step === 4 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-blue-50 mx-auto mb-4">
                  <Database className="w-8 h-8 text-blue-600" />
                </div>
                <CardTitle className="text-2xl">Your Health Data</CardTitle>
                <p className="text-gray-600">Upload or enter your health records, genetic info, and other medical data</p>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Data Type Selection */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {[
                    { type: 'ehr' as const, label: 'Electronic Health Records', icon: 'üìã' },
                    { type: 'genetic' as const, label: 'Genetic Information', icon: 'üß¨' },
                    { type: 'lab_results' as const, label: 'Lab Results', icon: 'üî¨' },
                    { type: 'imaging' as const, label: 'Medical Imaging', icon: 'üè•' },
                    { type: 'doctor_notes' as const, label: 'Doctor Notes', icon: 'üë©‚Äç‚öïÔ∏è' },
                    { type: 'family_history' as const, label: 'Family History', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
                    { type: 'other' as const, label: 'Other', icon: 'üìÑ' }
                  ].map((dataType) => (
                    <Card
                      key={dataType.type}
                      className="cursor-pointer hover:shadow-md transition-all border-2 border-dashed border-gray-300 hover:border-blue-400"
                      onClick={() => addUserData(dataType.type)}
                    >
                      <CardContent className="p-4 text-center">
                        <div className="text-2xl mb-2">{dataType.icon}</div>
                        <p className="text-xs font-medium">{dataType.label}</p>
                      </CardContent>
                    </Card>
                  ))}
                </div>

                {/* Existing User Data */}
                {userData.map((data) => (
                  <Card key={data.id} className="border border-blue-200 bg-blue-50">
                    <CardContent className="p-4 space-y-4">
                      <div className="flex justify-between items-start">
                        <div className="flex items-center space-x-2">
                          <span className="text-lg">
                            {data.type === 'ehr' && 'üìã'}
                            {data.type === 'genetic' && 'üß¨'}
                            {data.type === 'lab_results' && 'üî¨'}
                            {data.type === 'imaging' && 'üè•'}
                            {data.type === 'doctor_notes' && 'üë©‚Äç‚öïÔ∏è'}
                            {data.type === 'family_history' && 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'}
                            {data.type === 'other' && 'üìÑ'}
                          </span>
                          <h4 className="font-medium capitalize">{data.type.replace('_', ' ')}</h4>
                        </div>
                        <Button variant="ghost" size="sm" onClick={() => removeUserData(data.id)}>
                          <X className="w-4 h-4" />
                        </Button>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <Label>Title/Name</Label>
                          <Input
                            placeholder="e.g., Recent Blood Work"
                            value={data.title}
                            onChange={(e) => updateUserData(data.id, "title", e.target.value)}
                            className="mt-1 rounded-2xl"
                          />
                        </div>
                        <div>
                          <Label>Source</Label>
                          <Input
                            placeholder="e.g., Dr. Smith's Office"
                            value={data.source || ""}
                            onChange={(e) => updateUserData(data.id, "source", e.target.value)}
                            className="mt-1 rounded-2xl"
                          />
                        </div>
                      </div>
                      <div>
                        <Label>Description</Label>
                        <Textarea
                          placeholder="Brief description or key findings..."
                          value={data.description}
                          onChange={(e) => updateUserData(data.id, "description", e.target.value)}
                          className="mt-1 rounded-2xl"
                          rows={3}
                        />
                      </div>
                      <div className="flex items-center space-x-4">
                        <Button variant="outline" size="sm" className="rounded-full">
                          <Upload className="w-4 h-4 mr-2" />
                          Upload File
                        </Button>
                        <span className="text-xs text-gray-500">
                          Added {new Date(data.uploadDate).toLocaleDateString()}
                        </span>
                      </div>
                    </CardContent>
                  </Card>
                ))}

                {userData.length === 0 && (
                  <div className="text-center py-8 text-gray-500">
                    <Database className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p>No health data added yet. Click on a category above to get started.</p>
                  </div>
                )}

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(3)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button className="wellness-button-primary" onClick={() => setStep(5)}>
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 5: Emergency Contacts */}
          {step === 5 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-blue-50 mx-auto mb-4">
                  <Users className="w-8 h-8 text-blue-600" />
                </div>
                <CardTitle className="text-2xl">Emergency Contacts</CardTitle>
                <p className="text-gray-600">Add trusted contacts for emergencies</p>
              </CardHeader>
              <CardContent className="space-y-6">
                {emergencyContacts.map((contact, index) => (
                  <Card key={index} className="border border-blue-200 bg-blue-50">
                    <CardContent className="p-4 space-y-4">
                      <div className="flex justify-between items-start">
                        <h4 className="font-medium">Contact {index + 1}</h4>
                        <Button variant="ghost" size="sm" onClick={() => removeEmergencyContact(index)}>
                          Remove
                        </Button>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <Label>Name</Label>
                          <Input
                            placeholder="Full name"
                            value={contact.name}
                            onChange={(e) => updateEmergencyContact(index, "name", e.target.value)}
                            className="mt-1 rounded-2xl"
                          />
                        </div>
                        <div>
                          <Label>Relationship</Label>
                          <Select onValueChange={(value) => updateEmergencyContact(index, "relationship", value)}>
                            <SelectTrigger className="mt-1 rounded-2xl">
                              <SelectValue placeholder="Relationship" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="parent">Parent</SelectItem>
                              <SelectItem value="guardian">Guardian</SelectItem>
                              <SelectItem value="sibling">Sibling</SelectItem>
                              <SelectItem value="grandparent">Grandparent</SelectItem>
                              <SelectItem value="friend">Friend</SelectItem>
                              <SelectItem value="other">Other</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <Label>Phone Number</Label>
                          <Input
                            placeholder="Phone number"
                            value={contact.phone}
                            onChange={(e) => updateEmergencyContact(index, "phone", e.target.value)}
                            className="mt-1 rounded-2xl"
                          />
                        </div>
                        <div>
                          <Label>Email (Optional)</Label>
                          <Input
                            placeholder="Email address"
                            value={contact.email}
                            onChange={(e) => updateEmergencyContact(index, "email", e.target.value)}
                            className="mt-1 rounded-2xl"
                          />
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id={`primary-${index}`}
                          checked={contact.isPrimary}
                          onCheckedChange={(checked) => updateEmergencyContact(index, "isPrimary", checked)}
                        />
                        <Label htmlFor={`primary-${index}`}>Primary contact</Label>
                      </div>
                    </CardContent>
                  </Card>
                ))}

                {/* Add Contact Button */}
                <Card
                  className="border-2 border-dashed border-gray-300 cursor-pointer hover:border-blue-400 transition-colors"
                  onClick={addEmergencyContact}
                >
                  <CardContent className="p-6 text-center">
                    <Plus className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                    <p className="text-gray-600">Add Emergency Contact</p>
                  </CardContent>
                </Card>

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(4)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button className="wellness-button-primary" onClick={() => setStep(6)}>
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 6: Information Base & Protocols */}
          {step === 6 && (
            <ErrorBoundary>
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-purple-50 mx-auto mb-4">
                  <FileText className="w-8 h-8 text-purple-600" />
                </div>
                <CardTitle className="text-2xl">Information Base & Protocols</CardTitle>
                <p className="text-gray-600">Configure what informs your AI and set up health protocols for each condition</p>
              </CardHeader>
              <CardContent className="space-y-8">
                {/* Debug info */}
                {process.env.NODE_ENV === 'development' && (
                  <div className="text-xs text-gray-400 p-2 bg-gray-100 rounded">
                    Debug: mockInformationSources: {mockInformationSources?.length || 'undefined'}, 
                    mockProtocols: {mockProtocols?.length || 'undefined'}, 
                    selectedConditions: {selectedConditions?.length || 'undefined'}
                  </div>
                )}
                {selectedConditions && selectedConditions.length > 0 ? (
                  selectedConditions.map((condition) => {
                    // Safety check for condition data
                    if (!condition || !condition.id) {
                      console.warn('Invalid condition data:', condition)
                      return null
                    }
                    
                    return (
                    <Card key={condition.id} className="border-2 border-purple-200">
                      <CardHeader>
                        <CardTitle className="text-lg flex items-center">
                          <span className="text-2xl mr-3">
                            {diseasePresets.find(d => d.id === condition.id)?.icon || 'üè•'}
                          </span>
                          {condition.name}
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        {/* Information Base Section */}
                        <div className="space-y-4">
                          <h4 className="font-medium flex items-center">
                            <Database className="w-5 h-5 mr-2" />
                            Information Base
                          </h4>
                          <p className="text-sm text-gray-600">
                            Select what sources will inform the AI about {condition.name}
                          </p>
                          
                          {/* Preset Information Sources */}
                          <div className="space-y-3">
                            <h5 className="text-sm font-medium">Authoritative Medical Sources</h5>
                            {mockInformationSources && mockInformationSources.length > 0 ? mockInformationSources
                              .filter(source => source.applicableConditions && source.applicableConditions.includes(condition.id))
                              .map((source) => (
                                <Card key={source.id} className="border border-blue-200 bg-blue-50">
                                  <CardContent className="p-4">
                                    <div className="flex items-start justify-between">
                                      <div className="flex-1">
                                        <div className="flex items-center space-x-2 mb-2">
                                          <Checkbox
                                            checked={conditionInfoBases[condition.id]?.selectedPresets.includes(source.id) || false}
                                            onCheckedChange={(checked) => {
                                              setConditionInfoBases(prev => ({
                                                ...prev,
                                                [condition.id]: {
                                                  selectedPresets: checked 
                                                    ? [...(prev[condition.id]?.selectedPresets || []), source.id]
                                                    : (prev[condition.id]?.selectedPresets || []).filter(id => id !== source.id),
                                                  customSources: prev[condition.id]?.customSources || [],
                                                  excludedSources: prev[condition.id]?.excludedSources || []
                                                }
                                              }))
                                            }}
                                          />
                                          <h6 className="font-medium">{source.name}</h6>
                                          <Badge variant="secondary" className="text-xs">
                                            {source.reliability}% reliable
                                          </Badge>
                                        </div>
                                        <p className="text-sm text-gray-600 mb-2">{source.description}</p>
                                        <div className="text-xs text-gray-500">
                                          <strong>Covers:</strong> {source.topics.slice(0, 3).join(', ')}
                                          {source.topics.length > 3 && ` +${source.topics.length - 3} more`}
                                        </div>
                                      </div>
                                      <Button variant="ghost" size="sm">
                                        <Eye className="w-4 h-4" />
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              ))}
                          </div>
                        </div>

                        {/* Protocols Section */}
                        <div className="space-y-4">
                          <h4 className="font-medium flex items-center">
                            <Shield className="w-5 h-5 mr-2" />
                            Health Protocols
                          </h4>
                          <p className="text-sm text-gray-600">
                            Set up rules and guidelines for managing {condition.name}
                          </p>
                          
                          {/* Preset Protocols */}
                          <div className="space-y-3">
                            {mockProtocols && mockProtocols.length > 0 ? mockProtocols
                              .filter(protocol => protocol.applicableConditions && protocol.applicableConditions.includes(condition.id))
                              .map((protocol) => (
                                <Card key={protocol.id} className="border border-green-200 bg-green-50">
                                  <CardContent className="p-4">
                                    <div className="flex items-start justify-between">
                                      <div className="flex-1">
                                        <div className="flex items-center space-x-2 mb-2">
                                          <Checkbox
                                            checked={conditionProtocols[condition.id]?.some(p => p.id === protocol.id) || false}
                                            onCheckedChange={(checked) => {
                                              setConditionProtocols(prev => ({
                                                ...prev,
                                                [condition.id]: checked 
                                                  ? [...(prev[condition.id] || []), protocol]
                                                  : (prev[condition.id] || []).filter(p => p.id !== protocol.id)
                                              }))
                                            }}
                                          />
                                          <h6 className="font-medium">{protocol.name}</h6>
                                          <Badge variant="outline" className="text-xs">
                                            {protocol.type}
                                          </Badge>
                                        </div>
                                        <p className="text-sm text-gray-600 mb-2">{protocol.description}</p>
                                        <div className="text-xs text-gray-500 space-y-1">
                                          {protocol.rules.slice(0, 2).map((rule, idx) => (
                                            <div key={idx} className="flex items-start space-x-2">
                                              <span className="text-green-600">‚Ä¢</span>
                                              <span>
                                                <strong>If</strong> {rule.condition} ‚Üí <strong>Then</strong> {rule.action}
                                              </span>
                                            </div>
                                          ))}
                                          {protocol.rules.length > 2 && (
                                            <div className="text-gray-400">+{protocol.rules.length - 2} more rules</div>
                                          )}
                                        </div>
                                      </div>
                                      <Button variant="ghost" size="sm">
                                        <Settings className="w-4 h-4" />
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              )) : (
                                <div className="text-center py-4 text-gray-500">
                                  <p>No protocols available for this condition</p>
                                </div>
                              )}
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                    )
                  })
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <FileText className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p>No conditions selected yet. Go back to step 3 to add conditions.</p>
                  </div>
                )}

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(5)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button className="wellness-button-primary" onClick={() => setStep(7)}>
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
            </ErrorBoundary>
          )}

          {/* Step 7: Tools Selection */}
          {step === 7 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-green-50 mx-auto mb-4">
                  <Wrench className="w-8 h-8 text-green-600" />
                </div>
                <CardTitle className="text-2xl">Health Tracking Tools</CardTitle>
                <p className="text-gray-600">Select tools to track and manage your health conditions</p>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Tool Categories */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {toolPresets && toolPresets.length > 0 ? toolPresets.map((tool) => {
                    const isSelected = selectedTools.some(t => t.id === tool.id)
                    const isApplicable = selectedConditions.some(condition => 
                      tool.applicableConditions && tool.applicableConditions.includes(condition.id)
                    )
                    
                    return (
                      <Card
                        key={tool.id}
                        className={`cursor-pointer transition-all ${
                          isSelected 
                            ? 'border-green-300 bg-green-50 shadow-md' 
                            : isApplicable 
                              ? 'hover:border-green-200 hover:shadow-md' 
                              : 'opacity-50 cursor-not-allowed'
                        }`}
                        onClick={() => isApplicable && toggleTool(tool)}
                      >
                        <CardContent className="p-4">
                          <div className="flex items-start space-x-3">
                            <div className="text-2xl">{tool.icon}</div>
                            <div className="flex-1">
                              <div className="flex items-center justify-between mb-2">
                                <h4 className="font-medium">{tool.name}</h4>
                                {isSelected && (
                                  <div className="text-green-500">‚úì</div>
                                )}
                              </div>
                              <p className="text-sm text-gray-600 mb-3">{tool.description}</p>
                              
                              {/* Tool Features */}
                              <div className="space-y-2">
                                <div className="text-xs text-gray-500">
                                  <strong>Tracks:</strong> {tool.fields.slice(0, 2).map(f => f.label).join(', ')}
                                  {tool.fields.length > 2 && ` +${tool.fields.length - 2} more`}
                                </div>
                                
                                {tool.notifications && (
                                  <div className="flex items-center space-x-1 text-xs text-blue-600">
                                    <Bell className="w-3 h-3" />
                                    <span>Smart reminders</span>
                                  </div>
                                )}
                              </div>
                              
                              {/* Applicable Conditions */}
                              <div className="mt-3 flex flex-wrap gap-1">
                                {selectedConditions
                                  .filter(condition => tool.applicableConditions && tool.applicableConditions.includes(condition.id))
                                  .map(condition => (
                                    <Badge key={condition.id} variant="secondary" className="text-xs">
                                      {condition.name}
                                    </Badge>
                                  ))}
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    )
                  }) : (
                    <div className="text-center py-8 text-gray-500">
                      <Wrench className="w-12 h-12 mx-auto mb-4 opacity-50" />
                      <p>No tools available. Please check your configuration.</p>
                    </div>
                  )}
                </div>

                {/* Selected Tools Configuration */}
                {selectedTools.length > 0 && (
                  <div className="space-y-4">
                    <h4 className="font-medium">Configure Selected Tools</h4>
                    {selectedTools.map((tool) => (
                      <Card key={tool.id} className="border border-green-200 bg-green-50">
                        <CardContent className="p-4">
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <span className="text-lg">{tool.icon}</span>
                              <h5 className="font-medium">{tool.name}</h5>
                            </div>
                            <Button 
                              variant="ghost" 
                              size="sm" 
                              onClick={() => toggleTool(tool)}
                            >
                              Remove
                            </Button>
                          </div>
                          
                          {/* Tool Configuration Options */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {tool.notifications && (
                              <div className="space-y-2">
                                <Label className="text-sm">Reminder Frequency</Label>
                                <Select 
                                  onValueChange={(value) => 
                                    updateToolConfiguration(tool.id, { reminderFrequency: value })
                                  }
                                >
                                  <SelectTrigger className="rounded-2xl">
                                    <SelectValue placeholder="How often?" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="daily">Daily</SelectItem>
                                    <SelectItem value="twice-daily">Twice daily</SelectItem>
                                    <SelectItem value="weekly">Weekly</SelectItem>
                                    <SelectItem value="as-needed">As needed</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            )}
                            
                            <div className="space-y-2">
                              <Label className="text-sm">Data Sharing</Label>
                              <div className="flex items-center space-x-2">
                                <Checkbox 
                                  checked={tool.configuration?.shareWithDoctor || false}
                                  onCheckedChange={(checked) => 
                                    updateToolConfiguration(tool.id, { shareWithDoctor: checked })
                                  }
                                />
                                <span className="text-sm">Share with healthcare provider</span>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                )}

                {selectedTools.length === 0 && (
                  <div className="text-center py-8 text-gray-500">
                    <Wrench className="w-12 h-12 mx-auto mb-4 opacity-50" />
                    <p>No tools selected yet. Choose tools that match your conditions above.</p>
                  </div>
                )}

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(6)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button className="wellness-button-primary" onClick={() => setStep(8)}>
                    Continue <ChevronRight className="w-4 h-4 ml-2" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Step 8: Preferences & Final Setup */}
          {step === 8 && (
            <Card className="wellness-card">
              <CardHeader className="text-center">
                <div className="wellness-icon-container bg-orange-50 mx-auto mb-4">
                  <Settings className="w-8 h-8 text-orange-600" />
                </div>
                <CardTitle className="text-2xl">Preferences & Privacy</CardTitle>
                <p className="text-gray-600">Customize your experience and privacy settings</p>
              </CardHeader>
              <CardContent className="space-y-8">
                {/* Notification Preferences */}
                <div className="space-y-4">
                  <h4 className="font-medium flex items-center">
                    <Bell className="w-5 h-5 mr-2" />
                    Notification Preferences
                  </h4>
                  <div className="space-y-3">
                    {Object.entries(preferences.notifications).map(([key, value]) => (
                      <div key={key} className="flex items-center justify-between">
                        <Label htmlFor={key} className="text-sm">
                          {key === 'medication' && 'Medication reminders'}
                          {key === 'symptoms' && 'Symptom tracking reminders'}
                          {key === 'mood' && 'Mood check-in reminders'}
                          {key === 'appointments' && 'Appointment reminders'}
                          {key === 'reminders' && 'General health reminders'}
                        </Label>
                        <Switch
                          id={key}
                          checked={value}
                          onCheckedChange={(checked) => 
                            setPreferences(prev => ({
                              ...prev,
                              notifications: { ...prev.notifications, [key]: checked }
                            }))
                          }
                        />
                      </div>
                    ))}
                  </div>
                </div>

                {/* Privacy Settings */}
                <div className="space-y-4">
                  <h4 className="font-medium flex items-center">
                    <Shield className="w-5 h-5 mr-2" />
                    Privacy Settings
                  </h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label htmlFor="shareData" className="text-sm">
                        Share anonymized data for research
                      </Label>
                      <Switch
                        id="shareData"
                        checked={preferences.privacy.shareData}
                        onCheckedChange={(checked) => 
                          setPreferences(prev => ({
                            ...prev,
                            privacy: { ...prev.privacy, shareData: checked }
                          }))
                        }
                      />
                    </div>
                    <div className="flex items-center justify-between">
                      <Label htmlFor="analytics" className="text-sm">
                        Allow analytics to improve the app
                      </Label>
                      <Switch
                        id="analytics"
                        checked={preferences.privacy.analytics}
                        onCheckedChange={(checked) => 
                          setPreferences(prev => ({
                            ...prev,
                            privacy: { ...prev.privacy, analytics: checked }
                          }))
                        }
                      />
                    </div>
                  </div>
                </div>

                {/* Health Goals */}
                <div className="space-y-4">
                  <h4 className="font-medium">Health Goals</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {goals.map((goal) => (
                      <div key={goal} className="flex items-center space-x-2">
                        <Checkbox
                          id={goal}
                          checked={selectedGoals.includes(goal)}
                          onCheckedChange={() => handleGoalToggle(goal)}
                        />
                        <Label htmlFor={goal} className="text-sm">{goal}</Label>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="flex justify-between">
                  <Button variant="outline" onClick={() => setStep(7)} className="rounded-full">
                    <ChevronLeft className="w-4 h-4 mr-2" /> Back
                  </Button>
                  <Button
                    className="wellness-button-primary px-8 py-6 text-lg"
                    onClick={handleComplete}
                    disabled={loading}
                  >
                    {loading ? (
                      <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                    ) : (
                      <Heart className="w-5 h-5 mr-2" />
                    )}
                    {loading ? "Setting up..." : "Complete Setup"}
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Condition Selector Modal */}
        {showConditionSelector && (
          <ErrorBoundary>
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
              <div className="p-6 border-b">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-semibold">Select Health Conditions</h3>
                  <Button variant="ghost" size="sm" onClick={() => setShowConditionSelector(false)}>
                    <X className="w-4 h-4" />
                  </Button>
                </div>
                <p className="text-sm text-gray-600 mt-1">Choose from 20+ major chronic conditions</p>
              </div>
              <div className="p-6">
                {/* Custom Condition Input */}
                <div className="mb-6">
                  <Label className="text-sm font-medium">Add Custom Condition</Label>
                  <div className="flex gap-2 mt-2">
                    <Input
                      placeholder="Enter condition name (e.g., Fibromyalgia)"
                      value={customConditionName}
                      onChange={(e) => setCustomConditionName(e.target.value)}
                      className="rounded-2xl"
                    />
                    <Button
                      onClick={() => {
                        if (customConditionName.trim()) {
                          handleConditionAdd("", true, customConditionName.trim())
                          setCustomConditionName("")
                          setShowConditionSelector(false)
                        }
                      }}
                      disabled={!customConditionName.trim()}
                      className="wellness-button-primary"
                    >
                      Add
                    </Button>
                  </div>
                </div>

                {/* Disease Categories */}
                <div className="space-y-6">
                  {Object.entries(diseasesByCategory).length > 0 ? Object.entries(diseasesByCategory).map(([category, diseases]) => (
                    <div key={category}>
                      <h4 className="font-medium text-gray-900 mb-3 flex items-center">
                        <span className="text-sm bg-gray-100 px-2 py-1 rounded-full mr-2">{diseases.length}</span>
                        {category}
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {diseases.map((disease) => {
                          const isSelected = selectedConditions.some(c => c.id === disease.id)
                          return (
                            <Card
                              key={disease.id}
                              className={`cursor-pointer transition-all hover:shadow-md ${
                                isSelected ? 'border-red-300 bg-red-50 shadow-sm' : 'hover:border-red-200'
                              }`}
                              onClick={() => {
                                if (!isSelected) {
                                  handleConditionAdd(disease.id)
                                  setShowConditionSelector(false)
                                }
                              }}
                            >
                              <CardContent className="p-4">
                                <div className="flex items-start space-x-3">
                                  <span className="text-2xl flex-shrink-0">{disease.icon}</span>
                                  <div className="flex-1 min-w-0">
                                    <h4 className="font-medium text-sm leading-tight">{disease.name}</h4>
                                    <p className="text-xs text-gray-600 mt-1 overflow-hidden">{disease.description}</p>
                                    <div className="flex flex-wrap gap-1 mt-2">
                                      {disease.commonSymptoms.slice(0, 2).map((symptom, idx) => (
                                        <Badge key={idx} variant="secondary" className="text-xs px-1 py-0">
                                          {symptom}
                                        </Badge>
                                      ))}
                                      {disease.commonSymptoms.length > 2 && (
                                        <Badge variant="secondary" className="text-xs px-1 py-0">
                                          +{disease.commonSymptoms.length - 2}
                                        </Badge>
                                      )}
                                    </div>
                                  </div>
                                  {isSelected && (
                                    <div className="text-red-500 flex-shrink-0">‚úì</div>
                                  )}
                                </div>
                              </CardContent>
                            </Card>
                          )
                        })}
                      </div>
                    </div>
                  )) : (
                    <div className="text-center py-8">
                      <p className="text-gray-500">Loading conditions...</p>
                    </div>
                  )}
                </div>
              </div>
              <div className="p-6 border-t bg-gray-50">
                <div className="flex justify-between items-center">
                  <p className="text-sm text-gray-600">
                    {selectedConditions.length} condition{selectedConditions.length !== 1 ? 's' : ''} selected
                  </p>
                  <Button onClick={() => setShowConditionSelector(false)} className="wellness-button-primary">
                    Done
                  </Button>
                </div>
              </div>
            </div>
          </div>
          </ErrorBoundary>
        )}
      </main>
    </div>
  )
}
